function crc16changgong(t){let e=4119;for(let n=0;n<t.length;n++){e^=t.charCodeAt(n);for(let t=0;t<8;t++)1&~e?e>>=1:(e>>=1,e^=40961)}return e}function makePayload(t){const e=crc16changgong(t.slice(-5));return new Uint8Array([254,254,9,178,1,255&e,e>>8,0,112,226,235,32,1,1,0,0,0,108,48,0])}let bluetoothDevice,characteristic,isStarted=!1;function updateUi(t){const e=document.getElementById("main-button"),n=document.getElementById("device-name");document.getElementById("status");switch(t){case"pending":e.innerText="请稍后",e.disabled=!0,n.innerText="已连接："+bluetoothDevice.name;break;case"ok":e.innerText="结束",e.disabled=!1;break;case"standby":e.innerText="开启",e.disabled=!1,n.innerText="未连接"}}async function handleBluetoothError(t){if(t.toString().match(/User cancelled/)||"2"==t.toString())return;const e=document.getElementById("dialog-content");t.toString().match(/User denied the browser permission/)?e.innerText="蓝牙权限遭拒。\n\n请前往手机设置，授予浏览器“位置信息”权限。":t.toString().match(/NetworkError/)?(e.innerText="连接不稳定，无法与水控器建立连接。\n请重试。",window.location.reload()):!navigator.bluetooth||t.toString().match(/Bluetooth adapter not available/)||t.toString().match(/NotFoundError/)?e.innerText="找不到蓝牙硬件，或浏览器不支持。":e.innerText=t+"\n\n是什么呢\n\n这可能是一个Bug",document.getElementById("dialog").showModal(),bluetoothDevice&&await bluetoothDevice.gatt.disconnect(),isStarted=!1,updateUi("standby")}async function start(){try{bluetoothDevice=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"Water"}],optionalServices:[window.navigator.userAgent.match(/Bluefy/)?"generic_access":61936]}),updateUi("pending");const t=await bluetoothDevice.gatt.connect(),e=await t.getPrimaryService(61936);characteristic=await e.getCharacteristic(61937),await characteristic.writeValue(makePayload(bluetoothDevice.name)),isStarted=!0,updateUi("ok");const n=new Worker("timerWorker.js");n.postMessage({action:"start",duration:12e5}),n.onmessage=function(t){"timeout"===t.data&&isStarted&&end()}}catch(t){handleBluetoothError(t)}}async function end(){try{const t=new Uint8Array([254,254,9,179,0,0]);await characteristic.writeValue(t),await bluetoothDevice.gatt.disconnect(),isStarted=!1,updateUi("standby"),window.location.reload()}catch(t){handleBluetoothError(t)}}function handleButtonClick(){isStarted?end():start()}const xhr=new XMLHttpRequest;xhr.open("GET","https://api.countapi.xyz/hit/waterctl/visits"),xhr.responseType="json",xhr.send(),window.resizeTo(538,334);