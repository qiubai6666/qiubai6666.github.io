%0A%20%20%20%20function%20crc16changgong%28data%29%20%7B%0A%20%20%20%20%20%20%20%20let%20crc%20%3D%200x1017%3B%0A%20%20%20%20%20%20%20%20for%20%28let%20i%20%3D%200%3B%20i%20%3C%20data.length%3B%20i++%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20crc%20%5E%3D%20data.charCodeAt%28i%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20%28let%20j%20%3D%200%3B%20j%20%3C%208%3B%20j++%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20%28%28crc%20%26%200x0001%29%20%3D%3D%201%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20crc%20%3E%3E%3D%201%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20crc%20%5E%3D%200xA001%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20crc%20%3E%3E%3D%201%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20return%20crc%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20makePayload%28deviceName%29%20%7B%0A%20%20%20%20%20%20%20%20const%20checksum%20%3D%20crc16changgong%28deviceName.slice%28-5%29%29%3B%0A%20%20%20%20%20%20%20%20//%20prettier-ignore%0A%20%20%20%20%20%20%20%20return%20new%20Uint8Array%28%5B%0A%20%20%20%20%20%20%20%20%20%20%20%200xFE%2C%200xFE%2C%200x09%2C%200xB2%2C%0A%20%20%20%20%20%20%20%20%20%20%20%200x01%2C%20checksum%20%26%200xFF%2C%20checksum%20%3E%3E%208%2C%200x00%2C%0A%20%20%20%20%20%20%20%20%20%20%20%200x70%2C%200xE2%2C%200xEB%2C%200x20%2C%0A%20%20%20%20%20%20%20%20%20%20%20%200x01%2C%200x01%2C%200x00%2C%200x00%2C%0A%20%20%20%20%20%20%20%20%20%20%20%200x00%2C%200x6C%2C%200x30%2C%200x00%0A%20%20%20%20%20%20%20%20%5D%29%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20let%20bluetoothDevice%3B%0A%20%20%20%20let%20characteristic%3B%0A%20%20%20%20let%20isStarted%20%3D%20false%3B%0A%0A%20%20%20%20function%20updateUi%28stage%29%20%7B%0A%20%20%20%20%20%20%20%20const%20mainButton%20%3D%20document.getElementById%28%22main-button%22%29%3B%0A%20%20%20%20%20%20%20%20const%20deviceName%20%3D%20document.getElementById%28%22device-name%22%29%3B%0A%20%20%20%20%20%20%20%20const%20status%20%3D%20document.getElementById%28%22status%22%29%3B%0A%20%20%20%20%20%20%20%20switch%20%28stage%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20case%20%22pending%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mainButton.innerText%20%3D%20%22%u8BF7%u7A0D%u540E%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mainButton.disabled%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20deviceName.innerText%20%3D%20%22%u5DF2%u8FDE%u63A5%uFF1A%22%20+%20bluetoothDevice.name%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20case%20%22ok%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mainButton.innerText%20%3D%20%22%u7ED3%u675F%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mainButton.disabled%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20case%20%22standby%22%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mainButton.innerText%20%3D%20%22%u5F00%u542F%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20mainButton.disabled%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20deviceName.innerText%20%3D%20%22%u672A%u8FDE%u63A5%22%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20async%20function%20handleBluetoothError%28error%29%20%7B%0A%20%20%20%20%20%20%20%20//%20this%20is%20so%20fucking%20ugly%20but%20i%20have%20no%20choice%0A%20%20%20%20%20%20%20%20//%20you%20would%20never%20know%20how%20those%20shitty%20browsers%20behave%0A%20%20%20%20%20%20%20%20if%20%28error.toString%28%29.match%28/User%20cancelled/%29%20%7C%7C%20error.toString%28%29%20%3D%3D%20%222%22%29%20return%3B%20//%20%222%22%20is%20a%20weird%20behavior%20of%20Bluefy%20browser%20on%20iOS%0A%20%20%20%20%20%20%20%20const%20dialogContent%20%3D%20document.getElementById%28%22dialog-content%22%29%3B%0A%20%20%20%20%20%20%20%20if%20%28error.toString%28%29.match%28/User%20denied%20the%20browser%20permission/%29%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20dialogContent.innerText%20%3D%20%22%u84DD%u7259%u6743%u9650%u906D%u62D2%u3002%5Cn%5Cn%u8BF7%u524D%u5F80%u624B%u673A%u8BBE%u7F6E%uFF0C%u6388%u4E88%u6D4F%u89C8%u5668%u201C%u4F4D%u7F6E%u4FE1%u606F%u201D%u6743%u9650%u3002%5Cn%u6B64%u6743%u9650%u4E0D%u4F1A%u7528%u4E8E%u5B9A%u4F4D%uFF0C%u8BE6%u60C5%u8BF7%u53C2%u8003%u6E90%u4EE3%u7801%u4ED3%u5E93%u5185%u7684%22%3B%0A%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20%28error.toString%28%29.match%28/NetworkError/%29%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20dialogContent.innerText%20%3D%20%22%u8FDE%u63A5%u4E0D%u7A33%u5B9A%uFF0C%u65E0%u6CD5%u4E0E%u6C34%u63A7%u5668%u5EFA%u7ACB%u8FDE%u63A5%u3002%5Cn%u8BF7%u91CD%u8BD5%u3002%22%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20%28%21navigator.bluetooth%20%7C%7C%20error.toString%28%29.match%28/Bluetooth%20adapter%20not%20available/%29%20%7C%7C%20error.toString%28%29.match%28/NotFoundError/%29%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20dialogContent.innerText%20%3D%20%22%u627E%u4E0D%u5230%u84DD%u7259%u786C%u4EF6%uFF0C%u6216%u6D4F%u89C8%u5668%u4E0D%u652F%u6301%u3002%22%3B%0A%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20dialogContent.innerText%20%3D%20error%20+%20%22%5Cn%5Cn%u662F%u4EC0%u4E48%u5462%5Cn%5Cn%uFF08%u8FD9%u53EF%u80FD%u662F%u4E00%u4E2ABug%uFF0C%u8BF7%u622A%u56FE%u5E76%22%3B%0A%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20document.getElementById%28%22dialog%22%29.showModal%28%29%3B%0A%20%20%20%20%20%20%20%20if%20%28bluetoothDevice%29%20await%20bluetoothDevice.gatt.disconnect%28%29%3B%0A%20%20%20%20%20%20%20%20isStarted%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20updateUi%28%22standby%22%29%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20async%20function%20start%28%29%20%7B%0A%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20bluetoothDevice%20%3D%20await%20navigator.bluetooth.requestDevice%28%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20filters%3A%20%5B%7B%20namePrefix%3A%20%22Water%22%20%7D%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20optionalServices%3A%20%5Bwindow.navigator.userAgent.match%28/Bluefy/%29%20%3F%20%22generic_access%22%20%3A%200xF1F0%5D%20//%20workaround%20for%20Bluefy%0A%20%20%20%20%20%20%20%20%7D%29%3B%0A%20%20%20%20%20%20%20%20updateUi%28%22pending%22%29%3B%0A%20%20%20%20%20%20%20%20const%20server%20%3D%20await%20bluetoothDevice.gatt.connect%28%29%3B%0A%20%20%20%20%20%20%20%20const%20service%20%3D%20await%20server.getPrimaryService%280xF1F0%29%3B%0A%20%20%20%20%20%20%20%20characteristic%20%3D%20await%20service.getCharacteristic%280xF1F1%29%3B%0A%20%20%20%20%20%20%20%20await%20characteristic.writeValue%28makePayload%28bluetoothDevice.name%29%29%3B%0A%20%20%20%20%20%20%20%20isStarted%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20updateUi%28%22ok%22%29%3B%0A%0A%20%20%20%20%20%20%20%20//%20%u521B%u5EFAWeb%20Worker%0A%20%20%20%20%20%20%20%20const%20worker%20%3D%20new%20Worker%28%27timerWorker.js%27%29%3B%0A%20%20%20%20%20%20%20%20worker.postMessage%28%7Baction%3A%20%27start%27%2C%20duration%3A%2020%20*%2060%20*%201000%7D%29%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20worker.onmessage%20%3D%20function%28e%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20%28e.data%20%3D%3D%3D%20%27timeout%27%20%26%26%20isStarted%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20end%28%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%20catch%20%28error%29%20%7B%0A%20%20%20%20%20%20%20%20handleBluetoothError%28error%29%3B%0A%20%20%20%20%7D%0A%7D%0A%0A%20%20%20%20async%20function%20end%28%29%20%7B%0A%20%20%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20const%20endPayload%20%3D%20new%20Uint8Array%28%5B0xFE%2C%200xFE%2C%200x09%2C%200xB3%2C%200x00%2C%200x00%5D%29%0A%20%20%20%20%20%20%20%20%20%20%20%20await%20characteristic.writeValue%28endPayload%29%0A%20%20%20%20%20%20%20%20%20%20%20%20await%20bluetoothDevice.gatt.disconnect%28%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20isStarted%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20updateUi%28%22standby%22%29%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20//%20%u91CD%u65B0%u52A0%u8F7D%u7F51%u9875%0A%20%20%20%20%20%20%20%20%20%20%20%20window.location.reload%28%29%3B%20%0A%20%20%20%20%20%20%20%20%7D%20catch%20%28error%29%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20handleBluetoothError%28error%29%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20handleButtonClick%28%29%20%7B%0A%20%20%20%20%20%20%20%20isStarted%20%3F%20end%28%29%20%3A%20start%28%29%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20const%20xhr%20%3D%20new%20XMLHttpRequest%28%29%3B%0A%20%20%20%20xhr.open%28%22GET%22%2C%20%22https%3A//api.countapi.xyz/hit/waterctl/visits%22%29%3B%0A%20%20%20%20xhr.responseType%20%3D%20%22json%22%3B%0A%20%20%20%20xhr.send%28%29%3B%0A%0A%20%20%20%0A%0A%0A%0A%20%20%20%20//%20auto%20resize%20for%20desktop%0A%20%20%20%20window.resizeTo%28538%2C%20334%29%3B%0A
